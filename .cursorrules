# Araponga - Cursor Best Practices

**Vers√£o**: 1.0  
**Data**: 2025-01-20  
**Projeto**: Araponga - Plataforma Digital Comunit√°ria Orientada ao Territ√≥rio

---

## üéØ Princ√≠pios Fundamentais do Projeto

### Territ√≥rio como Refer√™ncia
- **Territory** √© geogr√°fico e neutro - representa apenas um lugar f√≠sico real
- Territ√≥rio existe antes do app e continua existindo sem usu√°rios
- L√≥gica social (memberships, visibilidade, modera√ß√£o) fica em camadas separadas
- **NUNCA** coloque l√≥gica social dentro da entidade Territory

### Nomenclatura Obrigat√≥ria
- ‚úÖ Use sempre **territory** (NUNCA "place" ou "location")
- ‚úÖ Use **items** (NUNCA "listings") para produtos do marketplace
- ‚úÖ Use **29 fases** (NUNCA "24 fases") ao referenciar backlog
- ‚úÖ Use **membership** para v√≠nculo usu√°rio-territ√≥rio
- ‚úÖ Use **visitor/resident** para pap√©is (NUNCA "user", "member" gen√©rico)

### Valores do Projeto
- Autonomia local
- Cuidado coletivo
- Continuidade da vida no territ√≥rio
- Fortalecimento do v√≠nculo entre pessoas e lugar
- **N√ÉO √©**: marketplace agressivo, rede de engajamento infinito, produto de vigil√¢ncia

---

## üèóÔ∏è Arquitetura e Estrutura

### Clean Architecture - Separa√ß√£o de Camadas

```
backend/
‚îú‚îÄ‚îÄ Araponga.Api          # API HTTP (controllers, endpoints, middlewares)
‚îú‚îÄ‚îÄ Araponga.Application  # Casos de uso / regras de aplica√ß√£o
‚îú‚îÄ‚îÄ Araponga.Domain       # Modelo de dom√≠nio (territory, regras centrais)
‚îú‚îÄ‚îÄ Araponga.Infrastructure # Persist√™ncia, integra√ß√µes, adapters
‚îú‚îÄ‚îÄ Araponga.Shared       # Tipos e utilit√°rios compartilhados
‚îî‚îÄ‚îÄ Araponga.Tests        # Testes automatizados
```

### Regras de Depend√™ncia
- ‚úÖ **Domain** n√£o depende de NADA (camada mais interna)
- ‚úÖ **Application** depende apenas de **Domain**
- ‚úÖ **Infrastructure** depende de **Domain** e **Application**
- ‚úÖ **Api** depende de todas as outras (camada mais externa)
- ‚ùå **NUNCA** importe Infrastructure ou Api em Domain ou Application

### Organiza√ß√£o de C√≥digo

#### Domain Layer
- Entidades de dom√≠nio (ex: `Territory`, `Membership`, `Post`)
- Value Objects (ex: `GeoAnchor`, `Address`)
- Interfaces de reposit√≥rios (ex: `ITerritoryRepository`)
- Exce√ß√µes de dom√≠nio (ex: `TerritoryNotFoundException`)
- **N√ÉO** coloque l√≥gica de persist√™ncia aqui

#### Application Layer
- Services (ex: `TerritoryService`, `PostCreationService`)
- DTOs de aplica√ß√£o (ex: `CreatePostRequest`, `PostResponse`)
- Interfaces de servi√ßos externos (ex: `IMediaStorageService`)
- **N√ÉO** coloque l√≥gica HTTP aqui

#### Infrastructure Layer
- Implementa√ß√µes de reposit√≥rios (ex: `PostgresTerritoryRepository`)
- Implementa√ß√µes de servi√ßos externos (ex: `S3MediaStorageService`)
- Configura√ß√µes (ex: `DbContext`, `ServiceCollectionExtensions`)
- **N√ÉO** coloque l√≥gica de neg√≥cio aqui

#### Api Layer
- Controllers (ex: `TerritoriesController`, `FeedController`)
- Middlewares (ex: `AuthenticationMiddleware`, `ErrorHandlingMiddleware`)
- Configura√ß√µes de API (ex: `Program.cs`, `Startup.cs`)
- **N√ÉO** coloque l√≥gica de neg√≥cio aqui

---

## üìù Padr√µes de C√≥digo

### Nomenclatura

#### Classes e Interfaces
- ‚úÖ Classes: `PascalCase` (ex: `TerritoryService`, `PostCreationService`)
- ‚úÖ Interfaces: `I` + `PascalCase` (ex: `ITerritoryRepository`, `IMediaStorageService`)
- ‚úÖ DTOs: `PascalCase` + sufixo descritivo (ex: `CreatePostRequest`, `PostResponse`)
- ‚úÖ Entidades: `PascalCase` (ex: `Territory`, `Membership`, `Post`)

#### M√©todos e Propriedades
- ‚úÖ M√©todos: `PascalCase` (ex: `CreatePostAsync`, `GetTerritoryByIdAsync`)
- ‚úÖ Propriedades: `PascalCase` (ex: `Id`, `Title`, `CreatedAtUtc`)
- ‚úÖ Campos privados: `_camelCase` (ex: `_repository`, `_logger`)

#### Vari√°veis e Par√¢metros
- ‚úÖ Vari√°veis locais: `camelCase` (ex: `territoryId`, `userId`)
- ‚úÖ Par√¢metros: `camelCase` (ex: `territoryId`, `cancellationToken`)

### Conven√ß√µes Espec√≠ficas

#### Async/Await
- ‚úÖ Todos os m√©todos ass√≠ncronos terminam com `Async` (ex: `GetTerritoryAsync`)
- ‚úÖ Sempre use `async`/`await` (NUNCA `.Result` ou `.Wait()`)
- ‚úÖ Sempre aceite `CancellationToken` em m√©todos ass√≠ncronos

#### Nullable Reference Types
- ‚úÖ Use `string?` para valores opcionais
- ‚úÖ Use `string` para valores obrigat√≥rios
- ‚úÖ Valide null antes de usar (use `ArgumentNullException.ThrowIfNull`)

#### Result Pattern
- ‚úÖ Use `Result<T>` ou `Result` para opera√ß√µes que podem falhar
- ‚úÖ NUNCA retorne `null` de m√©todos p√∫blicos
- ‚úÖ Use `Option<T>` ou `Maybe<T>` para valores opcionais

### Exemplos de C√≥digo

#### Service Pattern
```csharp
public class TerritoryService : ITerritoryService
{
    private readonly ITerritoryRepository _repository;
    private readonly ILogger<TerritoryService> _logger;

    public TerritoryService(
        ITerritoryRepository repository,
        ILogger<TerritoryService> logger)
    {
        _repository = repository;
        _logger = logger;
    }

    public async Task<Result<Territory>> GetTerritoryByIdAsync(
        Guid territoryId,
        CancellationToken cancellationToken = default)
    {
        ArgumentNullException.ThrowIfNull(territoryId);

        var territory = await _repository.GetByIdAsync(territoryId, cancellationToken);
        if (territory == null)
        {
            return Result<Territory>.NotFound($"Territory {territoryId} not found");
        }

        return Result<Territory>.Success(territory);
    }
}
```

#### Repository Pattern
```csharp
public interface ITerritoryRepository
{
    Task<Territory?> GetByIdAsync(Guid id, CancellationToken cancellationToken);
    Task<IEnumerable<Territory>> FindNearbyAsync(
        double latitude,
        double longitude,
        double radiusKm,
        int limit,
        CancellationToken cancellationToken);
    Task<Territory> AddAsync(Territory territory, CancellationToken cancellationToken);
}
```

---

## üß™ Testes

### Cobertura M√≠nima
- ‚úÖ **Cobertura >90%** obrigat√≥ria
- ‚úÖ Teste todos os casos de erro
- ‚úÖ Teste edge cases
- ‚úÖ Teste valida√ß√µes

### Estrutura de Testes
```
Araponga.Tests/
‚îú‚îÄ‚îÄ Domain/           # Testes de entidades e value objects
‚îú‚îÄ‚îÄ Application/      # Testes de services
‚îú‚îÄ‚îÄ Infrastructure/   # Testes de reposit√≥rios e adapters
‚îî‚îÄ‚îÄ Api/             # Testes de controllers (E2E)
```

### Padr√µes de Teste
- ‚úÖ Use `[Fact]` para testes do xUnit
- ‚úÖ Nomeie testes descritivamente: `MethodName_Scenario_ExpectedBehavior`
- ‚úÖ Use `InMemoryDataStore` para testes isolados
- ‚úÖ Use `WebApplicationFactory<T>` para testes E2E

### Exemplo de Teste
```csharp
[Fact]
public async Task GetTerritoryByIdAsync_WhenTerritoryExists_ReturnsTerritory()
{
    // Arrange
    var territory = new Territory("Test Territory", 0, 0);
    await _repository.AddAsync(territory, CancellationToken.None);

    // Act
    var result = await _service.GetTerritoryByIdAsync(territory.Id, CancellationToken.None);

    // Assert
    Assert.True(result.IsSuccess);
    Assert.Equal(territory.Id, result.Value.Id);
}
```

---

## üìö Documenta√ß√£o - OBRIGAT√ìRIO

### ‚ö†Ô∏è REGRA CR√çTICA: Atualiza√ß√£o Autom√°tica de Documenta√ß√£o

**SEMPRE que voc√™ fizer mudan√ßas no c√≥digo, voc√™ DEVE atualizar a documenta√ß√£o correspondente.**

### Quando Atualizar Documenta√ß√£o

1. **Mudan√ßas em Funcionalidades/Features:**
   - ‚úÖ Atualizar `docs/60_API_L√ìGICA_NEG√ìCIO.md` se mudar l√≥gica de neg√≥cio
   - ‚úÖ Atualizar `docs/22_COHESION_AND_TESTS.md` se implementar nova funcionalidade
   - ‚úÖ Atualizar `docs/03_BACKLOG.md` se completar um epic/feature
   - ‚úÖ Atualizar `docs/40_CHANGELOG.md` com mudan√ßas significativas
   - ‚úÖ Atualizar `README.md` se mudar funcionalidades listadas

2. **Mudan√ßas em Arquitetura:**
   - ‚úÖ Atualizar `docs/10_ARCHITECTURE_DECISIONS.md` se tomar nova decis√£o arquitetural
   - ‚úÖ Atualizar `docs/12_DOMAIN_MODEL.md` se mudar modelo de dom√≠nio
   - ‚úÖ Atualizar `docs/11_ARCHITECTURE_SERVICES.md` se mudar services

3. **Mudan√ßas em APIs/Endpoints:**
   - ‚úÖ Atualizar `docs/60_API_L√ìGICA_NEG√ìCIO.md` com novos endpoints ou mudan√ßas
   - ‚úÖ Atualizar `backend/Araponga.Api/wwwroot/devportal/index.html` se mudar DevPortal
   - ‚úÖ Atualizar exemplos de c√≥digo se mudar contratos

4. **Mudan√ßas em Fases do Backlog:**
   - ‚úÖ Atualizar `docs/backlog-api/FASE*.md` correspondente
   - ‚úÖ Atualizar `docs/backlog-api/README.md` se completar fase
   - ‚úÖ Atualizar `docs/STATUS_FASES.md` se existir
   - ‚úÖ Atualizar `docs/02_ROADMAP.md` se mudar roadmap
   - ‚úÖ Atualizar `docs/backlog-api/implementacoes/FASE*_IMPLEMENTACAO_RESUMO.md` se completar fase

5. **Mudan√ßas em Configura√ß√£o/Seguran√ßa:**
   - ‚úÖ Atualizar `docs/SECURITY_CONFIGURATION.md` se mudar configura√ß√µes
   - ‚úÖ Atualizar `docs/SECURITY_AUDIT.md` se adicionar medidas de seguran√ßa

### Checklist Obrigat√≥rio Antes de Commitar

- [ ] Documenta√ß√£o t√©cnica atualizada (se aplic√°vel)
- [ ] Exemplos de c√≥digo atualizados (se aplic√°vel)
- [ ] Changelog atualizado (se mudan√ßa significativa)
- [ ] README.md atualizado (se mudar funcionalidades principais)
- [ ] Documenta√ß√£o de API atualizada (se mudar endpoints)
- [ ] Documenta√ß√£o de fase atualizada (se completar fase)

### Guia Completo
Consulte `docs/CURSOR_DOCUMENTATION_RULES.md` para mapeamento completo de mudan√ßas ‚Üí documentos.

---

## üîí Seguran√ßa

### Valida√ß√£o de Entrada
- ‚úÖ Sempre valide entrada do usu√°rio
- ‚úÖ Use FluentValidation para DTOs
- ‚úÖ Sanitize strings antes de persistir
- ‚úÖ Valide geolocaliza√ß√£o (lat/lng dentro de ranges v√°lidos)

### Autoriza√ß√£o
- ‚úÖ Sempre verifique permiss√µes antes de opera√ß√µes sens√≠veis
- ‚úÖ Use `[Authorize]` em controllers
- ‚úÖ Verifique membership role (visitor/resident) quando necess√°rio
- ‚úÖ Valide territory ownership quando aplic√°vel

### Dados Sens√≠veis
- ‚úÖ NUNCA logue senhas, tokens ou dados pessoais
- ‚úÖ Use `[Sensitive]` attribute em logs quando necess√°rio
- ‚úÖ Criptografe dados sens√≠veis em repouso

---

## üöÄ Performance

### Queries
- ‚úÖ Use pagina√ß√£o em TODAS as listagens
- ‚úÖ Use `IQueryable` para queries eficientes
- ‚úÖ Evite N+1 queries (use `.Include()` ou proje√ß√µes)
- ‚úÖ Use √≠ndices no banco de dados

### Cache
- ‚úÖ Cache resultados de queries frequentes
- ‚úÖ Invalide cache quando dados mudarem
- ‚úÖ Use `IMemoryCache` ou `IDistributedCache` conforme necess√°rio

### Async
- ‚úÖ Use async/await para opera√ß√µes I/O
- ‚úÖ NUNCA bloqueie threads com `.Result` ou `.Wait()`
- ‚úÖ Configure `ConfigureAwait(false)` em libraries

---

## ‚úÖ Valida√ß√£o Antes de PR - OBRIGAT√ìRIO

### ‚ö†Ô∏è REGRA CR√çTICA: Build e Testes DEVEM Passar

**ANTES de criar qualquer PR, voc√™ DEVE:**

1. **Validar Build:**
   ```bash
   dotnet build --no-restore --configuration Release
   ```
   - ‚úÖ Build DEVE passar sem erros
   - ‚úÖ Apenas warnings aceit√°veis s√£o permitidos
   - ‚ùå NUNCA crie PR com erros de build

2. **Validar Testes:**
   ```bash
   dotnet test --no-build --configuration Release
   ```
   - ‚úÖ TODOS os testes DEVEM passar
   - ‚úÖ Cobertura de testes deve ser mantida (>90%)
   - ‚ùå NUNCA crie PR com testes falhando

3. **Verificar Conflitos de Merge:**
   ```bash
   git fetch origin main
   git merge origin/main
   ```
   - ‚úÖ Resolva TODOS os conflitos antes de criar PR
   - ‚úÖ Teste novamente ap√≥s resolver conflitos
   - ‚ùå NUNCA crie PR com conflitos n√£o resolvidos

### Checklist Obrigat√≥rio Antes de Criar PR

- [ ] **Build passa**: `dotnet build --no-restore --configuration Release` sem erros
- [ ] **Testes passam**: `dotnet test --no-build --configuration Release` todos passando
- [ ] **Sem conflitos**: `git merge origin/main` sem conflitos
- [ ] **Testes ap√≥s merge**: Se houve merge, rodar testes novamente
- [ ] **Documenta√ß√£o atualizada**: Verificar checklist de documenta√ß√£o
- [ ] **C√≥digo revisado**: Verificar se segue padr√µes do projeto

### Se Build ou Testes Falharem

1. **Verifique se os erros s√£o relacionados √†s suas mudan√ßas:**
   - Se SIM: **N√ÉO crie o PR** at√© corrigir
   - Se N√ÉO: Documente no PR que os testes falhando n√£o est√£o relacionados √†s mudan√ßas

2. **Se os erros s√£o relacionados √†s suas mudan√ßas:**
   - **N√ÉO crie o PR**
   - **Corrija os erros localmente**
   - **Valide novamente** (build + testes)
   - **Apenas ent√£o** crie o PR

3. **Se os erros N√ÉO s√£o relacionados √†s suas mudan√ßas:**
   - Documente no PR quais testes est√£o falhando e por que n√£o est√£o relacionados
   - Explique que os testes devem ser corrigidos em um PR separado
   - **Ainda assim, tente corrigir se poss√≠vel** (boa pr√°tica)

### Se Houver Conflitos de Merge

1. **N√ÉO crie o PR**
2. **Fa√ßa merge de `origin/main` na sua branch**
3. **Resolva TODOS os conflitos**
4. **Valide novamente** (build + testes)
5. **Apenas ent√£o** crie o PR

### Comandos de Valida√ß√£o R√°pida

```bash
# Valida√ß√£o completa antes de PR
git fetch origin main
git merge origin/main  # Resolve conflitos se houver
dotnet build --no-restore --configuration Release
dotnet test --no-build --configuration Release
```

**Se qualquer comando falhar, N√ÉO crie o PR at√© corrigir.**

---

## üì¶ Commits e PRs

### Mensagens de Commit
```
feat(module): Descri√ß√£o da funcionalidade

- Implementa [funcionalidade]
- Atualiza documenta√ß√£o em [arquivo(s)]
- Adiciona testes para [cobertura]

Documenta√ß√£o:
- Atualizado docs/60_API_L√ìGICA_NEG√ìCIO.md
- Atualizado docs/40_CHANGELOG.md
```

### Tipos de Commit
- `feat`: Nova funcionalidade
- `fix`: Corre√ß√£o de bug
- `docs`: Mudan√ßa em documenta√ß√£o
- `refactor`: Refatora√ß√£o de c√≥digo
- `test`: Adi√ß√£o ou corre√ß√£o de testes
- `chore`: Tarefas de manuten√ß√£o

### Pull Requests
- ‚úÖ Use o template `.github/pull_request_template.md`
- ‚úÖ Marque checklist de documenta√ß√£o
- ‚úÖ Descreva mudan√ßas claramente
- ‚úÖ Referencie issues relacionadas
- ‚úÖ Garanta que todos os testes passam

---

## üé® Design e UX

### Princ√≠pios de Design
- Territ√≥rio como refer√™ncia
- Baixa excita√ß√£o e foco
- Sil√™ncio funcional com hierarquia clara
- A√ß√£o consciente e expl√≠cita
- Evolu√ß√£o lenta e √≠ntegra

### O que √© Bem-vindo
- Legibilidade e redu√ß√£o de ru√≠do
- Consist√™ncia entre telas e estados
- Hierarquia visual clara
- Acessibilidade (contraste, foco, navega√ß√£o por teclado)

### O que Evitar
- Efeitos chamativos e distra√ß√µes
- Satura√ß√£o gratuita
- Anima√ß√µes celebrat√≥rias
- Met√°foras fechadas que reduzam leitura do contexto

---

## üîç Refer√™ncias R√°pidas

### Documenta√ß√£o Principal
- `docs/00_INDEX.md` - √çndice completo
- `docs/01_PRODUCT_VISION.md` - Vis√£o do produto
- `docs/02_ROADMAP.md` - Roadmap
- `docs/10_ARCHITECTURE_DECISIONS.md` - Decis√µes arquiteturais
- `docs/12_DOMAIN_MODEL.md` - Modelo de dom√≠nio
- `docs/60_API_L√ìGICA_NEG√ìCIO.md` - L√≥gica de neg√≥cio e APIs
- `docs/backlog-api/README.md` - Backlog completo (29 fases)

### Gloss√°rio
- `docs/05_GLOSSARY.md` - Termos e conceitos do projeto

### Contribuindo
- `docs/41_CONTRIBUTING.md` - Guia para contribuidores
- `docs/CURSOR_DOCUMENTATION_RULES.md` - Regras de documenta√ß√£o

---

## ‚ö†Ô∏è Lembretes Importantes

1. **Documenta√ß√£o desatualizada √© um bug cr√≠tico**
2. **Territory √© geogr√°fico e neutro - NUNCA coloque l√≥gica social nele**
3. **Sempre use "territory", "items", "29 fases" - nunca alternativas**
4. **Cobertura de testes >90% √© obrigat√≥ria**
5. **Sempre valide entrada e verifique autoriza√ß√£o**
6. **Use pagina√ß√£o em TODAS as listagens**
7. **Commits pequenos e focados s√£o prefer√≠veis**

---

**√öltima Atualiza√ß√£o**: 2025-01-20  
**Vers√£o**: 1.0
